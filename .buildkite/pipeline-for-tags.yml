# SPDX-FileCopyrightText: 2022 Oxhead Alpha
# SPDX-License-Identifier: LicenseRef-MIT-OA

env:
  USE_NEWER_NIX: 1
  DOCKER_BUILDKIT: 1
  SET_VERSION: "export OCTEZ_VERSION=\"$(cat meta.json | jq -r '.tezos_ref' | cut -d'/' -f3)\""


steps:
 - label: build-via-docker
   if: build.tag == "test-736"
   key: build-via-docker
   commands:
   - eval "$SET_VERSION"
   - cd docker
   - ./docker-static-build.sh
   artifact_paths:
     - ./docker/
     - ./binaries.txt
   agents:
     queue: "docker"


 - label: Update binaries list
   depends_on:
   - "build-via-docker"
   - "add-bigsur-hashes"
   if: build.tag == "test-736"
   key: update-binaries
   commands:
    - nix develop .#buildkite /tezos-packiging/.buildkite/update-binaries.sh "$BUILDKITE_TAG" "$(buildkite-agent artifact download binaries.txt)"
